# Diun Clean-Install (Korrigierte Version)
# Diese Version lädt die Konfiguration aus der "diun.yml"-Datei
# und hält sich an unsere Core Architectural Concepts [cite: 9-11].

services:
  diun:
    # Wir verwenden 'latest' wie in der Doku [cite: 1-5]
    image: crazymax/diun:latest
    container_name: diun
    restart: unless-stopped
    
    # 'command: serve' ist erforderlich, wenn eine diun.yml
    # verwendet wird (gemäß Doku [cite: 1-5]).
    command: serve

    labels:
      - "diun.enable=true"
    
    # SRE-FIX: Wir übergeben NUR noch Systemvariablen.
    # Diese werden vom start-all.sh-Skript [cite: 118-119]
    # aus der zentralen /docker/.env-Datei [cite: 9-11] geladen.
    environment:
      # Systemvariablen aus der globalen .env
      - "TZ=${TZ}"
      - "PUID=${PUID}"
      - "PGID=${PGID}"
      
      # SRE-FIX: Log-Level auf Debug erhöhen, um stille
      # Netzwerkfehler beim Senden des Webhooks zu sehen.
      - "LOG_LEVEL=debug"

    volumes:
      # Docker-Socket (read-only)
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      
      # SELinux :Z Flag (Kritisch für Fedora [cite: 9-11])
      - "./data:/data:Z"
      
      # SRE-FIX: Wir laden die Konfigurationsdatei
      # (Read-only und mit :Z Flag für SELinux).
      - "./diun.yml:/diun.yml:ro,Z"


    security_opt:
      - "label:type:container_t"
    # Netzwerk-Zuweisung, um n8n zu erreichen
    networks:
      - proxy-netzwerk

# Netzwerk-Definition (Root-Ebene)
networks:
  proxy-netzwerk:
    external: true

